<!DOCTYPE html><html lang="en"><head><meta charSet="UTF-8"/><title>Abhishek Kasana | Developer | Personal Homepage</title><meta name="description" content="Discover the world of software development with Abhishek Kasana, a passionate developer and tinkerer. Explore insightful blogs on coding, innovation, and the wonders of tech."/><meta name="keywords" content="Python, Database, Cryptography, React, Node.js, Docker, Software Engineering, Tech Innovation, Programming, Abhishek Kasana, Cuemath, Software Developer, Tech Blogger, Bangalore Tech Scene, India technology, PEC"/><link rel="shortcut icon" href="/static/images/logo/fav_icon.png"/><link rel="icon" href="/static/images/logo/fav_icon.png" type="image/png" sizes="16x16"/><meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/><meta name="next-head-count" content="7"/><style data-styled="gyeHdp gsUPRO hMeegh iVdbet bfMJEx kpPMkf jTvREQ iYyelC jDllNo fDtPr kbbmWi fiaTNS kHnSsf hjnUaQ jtQZgg jhOGph iIBMez hHGolF dKzTjX zNqEy hkRFFU iMGZwi cUfkRj etbdhk" data-styled-version="4.4.1">
/* sc-component-id: sc-bdVaJa */
.hMeegh{box-sizing:border-box;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex:0 1 auto;-ms-flex:0 1 auto;flex:0 1 auto;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}
/* sc-component-id: sc-EHOje */
.jTvREQ{font-size:18px;color:#fff !important;}.iYyelC{font-size:18px;color:#EA4C89 !important;}
/* sc-component-id: sc-bZQynM */
.gyeHdp{background:#44475A;box-shadow:0 2px #FFF053;}
/* sc-component-id: sc-gzVnrw */
.gsUPRO{box-sizing:border-box;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex:0 1 auto;-ms-flex:0 1 auto;flex:0 1 auto;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-right:auto;margin-left:auto;padding:0;overflow:hidden;} @media (min-width:1025px){.gsUPRO{max-width:960px;}}
/* sc-component-id: sc-htoDjs */
.iVdbet{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:32px;height:auto;font-size:24px;margin:6px 18px 6px 0;-webkit-text-decoration:none;text-decoration:none;border-radius:2px;border:3px solid #bd93f9;color:inherit;} @media (max-width:1024px){.iVdbet{margin:6px 18px 6px 16px;}}
/* sc-component-id: sc-dnqmqq */
.bfMJEx{padding:12px 12px 12px 0;margin:auto;}
/* sc-component-id: sc-iwsKbI */
.jDllNo{box-sizing:border-box;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex:0 1 auto;-ms-flex:0 1 auto;flex:0 1 auto;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-left:auto;margin-right:unset;}
/* sc-component-id: sc-gZMcBi */
.fDtPr{height:25px;width:25px;padding:12px;display:block;text-align:center;-webkit-text-decoration:none;text-decoration:none;-webkit-transition:0.5s;transition:0.5s;-o-transition:0.5s;-ms-transition:0.5s;-moz-transition:0.5s;-webkit-transition:0.5s;} .fDtPr:hover{-webkit-transform:scale(1.1);-ms-transform:scale(1.1);transform:scale(1.1);background-color:#1b1c30;box-shadow:0 0 8px 2px #0073a4;} @media (max-width:1024px){.fDtPr{padding:12px 6px;}}.kbbmWi{height:25px;width:25px;padding:12px;display:block;text-align:center;-webkit-text-decoration:none;text-decoration:none;-webkit-transition:0.5s;transition:0.5s;-o-transition:0.5s;-ms-transition:0.5s;-moz-transition:0.5s;-webkit-transition:0.5s;} .kbbmWi:hover{-webkit-transform:scale(1.1);-ms-transform:scale(1.1);transform:scale(1.1);background-color:#1b1c30;box-shadow:0 0 8px 2px #f48024;} @media (max-width:1024px){.kbbmWi{padding:12px 6px;}}.fiaTNS{height:25px;width:25px;padding:12px;display:block;text-align:center;-webkit-text-decoration:none;text-decoration:none;-webkit-transition:0.5s;transition:0.5s;-o-transition:0.5s;-ms-transition:0.5s;-moz-transition:0.5s;-webkit-transition:0.5s;} .fiaTNS:hover{-webkit-transform:scale(1.1);-ms-transform:scale(1.1);transform:scale(1.1);background-color:#1b1c30;box-shadow:0 0 8px 2px #00aced;} @media (max-width:1024px){.fiaTNS{padding:12px 6px;}}.kHnSsf{height:25px;width:25px;padding:12px;display:block;text-align:center;-webkit-text-decoration:none;text-decoration:none;-webkit-transition:0.5s;transition:0.5s;-o-transition:0.5s;-ms-transition:0.5s;-moz-transition:0.5s;-webkit-transition:0.5s;} .kHnSsf:hover{-webkit-transform:scale(1.1);-ms-transform:scale(1.1);transform:scale(1.1);background-color:#1b1c30;box-shadow:0 0 8px 2px #24292d;} @media (max-width:1024px){.kHnSsf{padding:12px 6px;}}
/* sc-component-id: sc-gqjmRU */
.hjnUaQ{max-width:100%;max-height:100%;}
/* sc-component-id: sc-VigVT */
.kpPMkf{-webkit-text-decoration:none;text-decoration:none;}
/* sc-component-id: sc-fjdhpX */
.jtQZgg{height:inherit;margin:0 auto;padding:16px;margin:auto;} @media (min-width:1025px){.jtQZgg{max-width:960px;padding:0;}}
/* sc-component-id: sc-kAzzGY */
.dKzTjX{font-size:32px;margin:.4em 0;font-weight:500;} @media (max-width:1024px){.dKzTjX{font-size:26px;}}
/* sc-component-id: sc-chPdSV */
.hHGolF{margin:16px 0;border:none;background:#f5f8fa;height:2px;}
/* sc-component-id: sc-kgoBCf */
.iIBMez{font-size:70px;font-weight:400;-webkit-letter-spacing:-1px;-moz-letter-spacing:-1px;-ms-letter-spacing:-1px;letter-spacing:-1px;line-height:1.1;margin-bottom:3%;} @media (max-width:1024px){.iIBMez{font-size:54px;}} @media (max-width:767px){.iIBMez{font-size:42px;}}
/* sc-component-id: sc-kGXeez */
.etbdhk{font:normal 16px monospace;background-color:#484959;border:1px solid #E7E7E7;padding:12px;margin:16px 0;border-radius:2px;white-space:pre-wrap;overflow:auto;}
/* sc-component-id: sc-dxgOiQ */
.cUfkRj{-webkit-text-decoration-line:underline;text-decoration-line:underline;-webkit-text-decoration-color:#c3a5ff;text-decoration-color:#c3a5ff;color:#c3a5ff;}
/* sc-component-id: sc-hSdWYo */
.iMGZwi{cursor:pointer;} .iMGZwi > :last-child::after{content:'+';color:#FFF053;font-family:monospace;float:right;display:inline-block;padding-left:12px;} @-webkit-keyframes blinker{50%{opacity:0;}} @keyframes blinker{50%{opacity:0;}}
/* sc-component-id: sc-eHgmQL */
.hkRFFU{margin-bottom:2em !important;margin:1em 0 0 0 !important;}
/* sc-component-id: sc-cvbbAY */
.jhOGph{text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;color:#f5f8fa;text-shadow:none;font-size:1.125rem;line-height:1.5;margin-bottom:5em;white-space:pre-wrap;} @media(max-width:767px){.jhOGph{font-size:1.0625rem;}}
/* sc-component-id: sc-jWBwVP */
.zNqEy{background-color:#484959;padding:2px 4px;border-radius:3px;}</style><style>
                /* custom! */
                body {
                    margin: 0;
                    background: #282A36;
                    color: white;
                    font-family: Verdana, DejaVu Sans, sans-serif;
                    ::selection {
                      background-color: #BD93F9;
                      color: #FFFFFF;
                    }
                } 
            </style><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-5752944655d749a0.js" defer=""></script><script src="/_next/static/chunks/framework-5f4595e5518b5600.js" defer=""></script><script src="/_next/static/chunks/main-3f94d2de14fe4c1a.js" defer=""></script><script src="/_next/static/chunks/pages/_app-d019ca2d24f7755c.js" defer=""></script><script src="/_next/static/chunks/115-b27358486d183b22.js" defer=""></script><script src="/_next/static/chunks/37-ac0adf65541a0b11.js" defer=""></script><script src="/_next/static/chunks/pages/blog/text-search-in-postgresql-72c3c53f27be74c0.js" defer=""></script><script src="/_next/static/_LyH80OrSs48BerJMbDhN/_buildManifest.js" defer=""></script><script src="/_next/static/_LyH80OrSs48BerJMbDhN/_ssgManifest.js" defer=""></script><script src="/_next/static/_LyH80OrSs48BerJMbDhN/_middlewareManifest.js" defer=""></script><style data-href="https://fonts.googleapis.com/css2?family=Lato">@font-face{font-family:'Lato';font-style:normal;font-weight:400;src:url(https://fonts.gstatic.com/s/lato/v24/S6uyw4BMUTPHvxo.woff) format('woff')}@font-face{font-family:'Lato';font-style:normal;font-weight:400;src:url(https://fonts.gstatic.com/s/lato/v24/S6uyw4BMUTPHjxAwXiWtFCfQ7A.woff2) format('woff2');unicode-range:U+0100-02BA,U+02BD-02C5,U+02C7-02CC,U+02CE-02D7,U+02DD-02FF,U+0304,U+0308,U+0329,U+1D00-1DBF,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20C0,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Lato';font-style:normal;font-weight:400;src:url(https://fonts.gstatic.com/s/lato/v24/S6uyw4BMUTPHjx4wXiWtFCc.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style></head><body class="custom_class"><div id="__next" data-reactroot=""><div><div class="sc-bZQynM gyeHdp"><div class="sc-bdVaJa sc-gzVnrw gsUPRO"><div class="sc-bdVaJa hMeegh"><a href="/" class="sc-htoDjs iVdbet">K</a><div class="sc-dnqmqq bfMJEx"><a href="/about-me" class="sc-VigVT kpPMkf"><span color="#fff" class="sc-EHOje jTvREQ">about</span></a></div></div><div class="sc-bdVaJa sc-iwsKbI jDllNo"><a href="https://www.linkedin.com/in/abhishek-kasana-4a7836106" class="sc-gZMcBi fDtPr"><img alt="linked-in" src="https://img.icons8.com/ios-glyphs/128/ffffff/linkedin.png" class="sc-gqjmRU hjnUaQ"/></a><a href="https://stackoverflow.com/users/9057473/" class="sc-gZMcBi kbbmWi"><img alt="stackoverflow" src="https://img.icons8.com/ios/128/ffffff/stackoverflow-filled.png" class="sc-gqjmRU hjnUaQ"/></a><a href="https://twitter.com/abhishekasana" class="sc-gZMcBi fiaTNS"><img alt="twitter" src="https://img.icons8.com/ios-glyphs/128/ffffff/twitter-circled.png" class="sc-gqjmRU hjnUaQ"/></a><a href="https://github.com/abhishekasana" class="sc-gZMcBi kHnSsf"><img alt="github" src="https://img.icons8.com/ios-glyphs/128/ffffff/github.png" class="sc-gqjmRU hjnUaQ"/></a></div></div></div><div class="sc-jTzLTM sc-fjdhpX jtQZgg"><div class="sc-cSHVUG sc-cvbbAY jhOGph"><h1 class="sc-kgoBCf iIBMez">Text Search in PostgreSQL</h1>In this article, I&#x27;m documenting some of my findings when weighing different ways to implement text search in Postgres. We will also compare how these DB methods hold against external search systems like elasticsearch/Solr.<hr class="sc-chPdSV hHGolF"/><h2 class="sc-kAzzGY dKzTjX">Available Options</h2>Postgres offers several tools for pattern matching and searching text. There&#x27;s:<ul><li><code class="sc-jWBwVP zNqEy">LIKE</code>, <code class="sc-jWBwVP zNqEy">SIMILAR TO</code>, Regex</li><li>Trigram index</li><li>Full Text Search</li></ul>Each of these searching options can be implemented with multiple choices of index. Postgres provides several index types: B-tree, Hash, GiST, GIN &amp; BRIN. Each index type uses a different algorithm that is best suited to different types of queries.<br/><div style="margin:1em 0 0 0 !important;collapsed-accordion:+;expanded-accordion:-;accordion-position:right" class="sc-jzJRlG sc-eHgmQL hkRFFU"><div style="margin:1em 0 0 0 !important;collapsed-accordion:+;expanded-accordion:-;accordion-position:right" class="sc-hSdWYo iMGZwi"><h2 class="sc-kAzzGY dKzTjX">Database setup</h2></div></div><h2 class="sc-kAzzGY dKzTjX">LIKE &amp; Regex for pattern search</h2>To implement a search we can think of a simple <a href="https://www.postgresql.org/docs/current/functions-matching.html" class="sc-dxgOiQ cUfkRj">pattern search</a> where we are filtering the rows based on a exact pattern i.e <code class="sc-jWBwVP zNqEy">LIKE pattern</code> or <code class="sc-jWBwVP zNqEy">~ pattern</code><br/><div class="sc-kGXeez etbdhk">-- LIKE<br/>-- &quot;%&quot; means wildcard character denoting any string<br/>-- search users with username&#x27;s starting with alice i.e pattern = &#x27;alice%&#x27;<br/>SELECT * FROM users WHERE username LIKE &#x27;alice%&#x27;;<br/>-- search users with username&#x27;s containing alice i.e pattern = &#x27;%alice%&#x27;<br/>SELECT * FROM users WHERE username LIKE &#x27;%alice%&#x27;;<br/><br/>-- Regex (~) &amp; SIMILAR TO<br/>-- &quot;.*&quot; denotes any string<br/>-- SIMILAR TO expressions are rewritten into regular expressions internally<br/>-- search users with username&#x27;s starting with alice i.e pattern = &#x27;^alice.*&#x27;<br/>SELECT * FROM users WHERE username ~ &#x27;^alice.*&#x27;;</div>Searching on a million rows will require you to build an index on the searched column (or multi-columns).<div class="sc-kGXeez etbdhk">EXPLAIN (COSTS OFF) SELECT * FROM users WHERE username LIKE &#x27;alice%&#x27;;<br/>-- Seq Scan on users</div>The default index in Postgres is the B-tree which fits in most situations.<br/><span color="#EA4C89" class="sc-EHOje iYyelC">B-tree index</span> only provide index scan on access predicates (= operator) and range queries. We need to create the index with a special operator class to support indexing of pattern-matching that too only left-anchored i.e &#x27;pattern%&#x27; or &#x27;patt%ern&#x27;. This prefix pattern search makes sense once you understand how a B-tree (B+tree) index works.<div class="sc-kGXeez etbdhk">CREATE INDEX col_search ON table (col text_pattern_ops);<br/>EXPLAIN (COSTS OFF) SELECT * FROM users WHERE username LIKE &#x27;alice%&#x27;;<br/>-- Index Scan using col_search_idx on users</div><h2 class="sc-kAzzGY dKzTjX">Trigram index</h2>Another way of implementing a search instead of a direct pattern match can be a <strong>fuzzy search</strong> where the searches for a text that matches a term closely instead of a exact match like username matching &quot;Ailce&quot; search should also return the username &quot;Alice&quot; too.<br/>To build this fuzzy search lets see the concept of Trigram. A trigram is a group of three consecutive characters taken from a string. We can measure the similarity of two strings by counting the number of trigrams they share. This simple idea turns out to be very effective for measuring the similarity of words in many natural languages. This similarity function allows for narrowing our filter similar to what <a href="https://en.wikipedia.org/wiki/Levenshtein_distance" class="sc-dxgOiQ cUfkRj">levenshtein</a> algorithm does.<br/>By using the operator classes provided by the module <code class="sc-jWBwVP zNqEy">pg_trgm</code> provides index support for any <code class="sc-jWBwVP zNqEy">LIKE/ ILIKE</code> pattern using a GIN or GiST index, also supporting the word_similarity operators. Effectiveness of trigram index varies with the exact data set. For example, the trigram for &quot;alice&quot; would be:<div class="sc-kGXeez etbdhk">-- install module CREATE EXTENSION pg_trgm;<br/>select show_trgm(&#x27;alice&#x27;);<br/>-- output - <!-- -->{&quot;  a&quot;,&quot; al&quot;,ali,&quot;ce &quot;,ice,lic}</div>We can create index on these trigram&#x27;s using a GIN or a GiST index operator classes provided by the<code class="sc-jWBwVP zNqEy">pg_trgm</code>.<br/><span color="#EA4C89" class="sc-EHOje iYyelC">GIN index</span> (<a href="http://www.sai.msu.su/~megera/wiki/Gin" class="sc-dxgOiQ cUfkRj">generalised inverted index</a>) an inverted index maps entities to its position in a table. An inverted index is an index structure storing a set of (key, posting list) pairs, where &#x27;posting list&#x27; is a set of documents in which the key occurs. GIN works well on composite data types (consisting of multiple elements e.g array, json, etc.)<br/>Note: GIN only supports bitmap queries, as index tree only maintains the heap pointers.<br/><span color="#EA4C89" class="sc-EHOje iYyelC">GiST index</span> (generalized search tree) a balanced search tree more optimized towards handling geodata, text documents, images, etc. In case of text a trie like structure is built which spread across multiple page index.<br/>Note: GiST and GIN both index types can be used to speed up text searches. But, creating and maintaining these index carries a cost &amp; there are substantial performance differences between the two of them. You can read further <a href="https://www.postgresql.org/docs/12/textsearch-indexes.html" class="sc-dxgOiQ cUfkRj">here</a> to make a decision which index operator class fits your use case.<br/>As a rule of thumb, a GIN index is faster to search than a GiST index, but slower to build or update. So, GIN is better suited for static data and GiST for often-updated data. I will be using GIN operator class index for our trigram exploration.<div class="sc-kGXeez etbdhk">CREATE INDEX col_gin_trgm_idx ON table USING gin (col gin_trgm_ops);<br/>SELECT col, similarity(col, &#x27;word&#x27;) AS sml FROM table WHERE col % &#x27;word&#x27; ORDER BY sml DESC, col;<br/>SELECT * FROM table WHERE col LIKE &#x27;%foo%bar&#x27;;<br/>-- The index search works by extracting trigrams from the search string and then looking these up in the index. The more trigrams in the search string, the more effective the index search is.<br/>-- Unlike B-tree based searches, the search string need not be left-anchored.</div><h2 class="sc-kAzzGY dKzTjX">Full Text Search</h2>Postgres provides a advance full-text search out of box since PostgreSQL 8.3. It is based on TF-IDF concept. It involves multiple pre-index steps lemmatize, stemming, ignoring stop words, weight and rank search matches. This gives us the ability to index and search in large amounts of text data.<br/>Imagine, we have a blog table having a million rows each containing documents that are not just meta-data but rather an abstract for an article, or full-text articles themselves, and you want to find out if certain words are present or not in them.<br/>An effective way to approach this problem is by getting a semantic vector [vectorization] for all of the words contained in a document. So, when you search for a word like &quot;jump&quot;, you will match all instances of the word and its tenses, even if you searched for &quot;jumped&quot; or &quot;jumping&quot;. Additionally, you won&#x27;t be searching the full document itself, but the vector [querying].<br/>Postgres offers several native functions to implement this full-fledged text search, here are few to get started -<br/><ul><li><code class="sc-jWBwVP zNqEy">to_tsvector</code> [vectorization]- creates a list of tokens of tsvector (text search vector) data type. Every token is a lexeme (unit of lexical meaning) with pointers (the positions in the document), and here words that carry little meaning, such as articles (the) and conjunctions (and, or) are conveniently omitted.</li><li><code class="sc-jWBwVP zNqEy">to_tsquery</code> [querying] - querying the vector occurrences of a particular word/prhase</li></ul><div class="sc-kGXeez etbdhk">-- VECTORIZATION<br/>SELECT to_tsvector(&#x27;The quick brown fox jumped over the lazy dog.&#x27;);<br/>-- &#x27;brown&#x27;:3 &#x27;dog&#x27;:9 &#x27;fox&#x27;:4 &#x27;jump&#x27;:5 &#x27;lazi&#x27;:8 &#x27;quick&#x27;:2<br/><br/>-- QUERYING<br/>SELECT to_tsvector(&#x27;The quick brown fox jumped over the lazy dog&#x27;) @@ to_tsquery(&#x27;fox&#x27;);</div><div class="sc-kGXeez etbdhk">-- Try FTS without Index<br/>SELECT * FROM table WHERE to_tsvector(&#x27;english&#x27;, body) @@ to_tsquery(&#x27;english&#x27;, &#x27;hello&#x27;);<br/><br/>-- Lets try building an Index<br/>CREATE INDEX v_search_idx ON table USING GIN (to_tsvector(&#x27;english&#x27;, body));<br/><br/><br/>-- left anchored<br/>SELECT * FROM users WHERE ts_username @@ to_tsquery(&#x27;simple&#x27;, &#x27;alice:*&#x27;);<br/>-- search<br/>select * from users where ts_username @@ to_tsquery(&#x27;simple&#x27;,&#x27;alice&#x27;);</div>PostgresSQL full text search works best when the text vectors are stored in physical columns with an index. This means you’d have to set up a stored procedure or database trigger to keep these text vector columns updated with newest value from the raw data.<br/>Note: To implement multi-column text search using above options a new column maintaining these tokenized values including amalgam of these multi-column indexes will be required, with stored procedure or database trigger to keep them in sync.<h2 class="sc-kAzzGY dKzTjX">External Search Engine -</h2><span color="#EA4C89" class="sc-EHOje iYyelC">Elasticsearch - </span>A dedicated search system, maintaining a document with GIN index like manner while preserving the original document. ElasticSearch showcases searches &amp; log analytics in near-real-time and a scalable manner. Elasticsearch (&amp; other dedicated search systems) are far better-known for text search but here are few benefits of Postgres over a dedicated search system:<ul><li>avoid operating additional infrastructure (e.g., spinning up an Elasticsearch cluster)</li><li>avoid syncing data between systems (e.g., every CRUD operation needs to be relayed from Postgres to Elasticsearch)</li></ul>If search is your core offering, or you can’t afford to fit your searchable text in Postgres shared memory buffer, use Elasticsearch. Otherwise, Postgres is probably good enough. At the very least, you’ll end up with a competent baseline for further improvement.</div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/blog/text-search-in-postgresql","query":{},"buildId":"_LyH80OrSs48BerJMbDhN","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>